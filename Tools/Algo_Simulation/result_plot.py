import matplotlib.pyplot as plt
import numpy as np

# 导入find_thresholds4.py中的compute_thresholds
from find_threshold5 import compute_thresholds

def plot_data_with_thresholds5(original_data, result):
    data = np.array(original_data)
    t1, x, t2, y = result["t1"], result["x"], result["t2"], result["y"]

    plt.figure(figsize=(15, 7))
    plt.plot(data, label='Original Data', color='gray', alpha=0.5)

    # 有效区间
    valid_data = np.copy(data).astype(float)
    valid_data[:40] = np.nan
    valid_data[171:] = np.nan
    plt.plot(valid_data, label='Effective Range Data', color='blue')

    # 阈值区域
    plt.fill_between(range(40, x), 0, t1, color='red', alpha=0.3, label=f'Threshold Area 1 (t1={t1})')
    if y > x:
        plt.fill_between(range(x, y), 0, t2, color='orange', alpha=0.3, label=f'Threshold Area 2 (t2={t2})')

    # 标记识别出的波峰
    for p in result.get("peaks", []):
        idx = p["idx"]
        amp = p["amp"]
        role = p["role"]
        if role == "edge":
            plt.plot(idx, amp, 'x', color='red', markersize=10, label=f'Edge Peak ({idx})')
        elif role == "liquid":
            plt.plot(idx, amp, '*', color='green', markersize=10, label=f'Liquid Peak ({idx})')
        elif role == "interf":
            plt.plot(idx, amp, 'o', color='purple', markersize=8, label=f'Interf Peak ({idx})')

    plt.title('Thresholds3 Result Visualization')
    plt.xlabel('Data Point Index')
    plt.ylabel('Amplitude')
    plt.legend()
    plt.grid(True)
    plt.axhline(y=250, color='r', linestyle='--', label='Base Threshold (250)')
    plt.axvline(x=40, color='k', linestyle=':')
    plt.axvline(x=170, color='k', linestyle=':')
    plt.xlim(0, 224)
    plt.ylim(bottom=0)
    plt.show()

# 示例数据
#sample_data = [0,22,121,236,203,303,1584,4356,6872,7328,6317,5193,4294,3491,2802,2275,1882,1587,1446,2078,4010,5826,5917,4969,4101,3387,2756,2276,1892,1536,1251,1065,925,773,624,509,426,341,248,199,167,126,127,101,70,64,69,39,42,74,44,26,25,29,17,37,50,55,38,16,48,39,20,29,7,16,10,27,43,20,15,5,19,20,17,8,5,6,36,48,5,34,35,60,30,18,23,13,26,17,18,4,3,28,20,27,7,20,4,17,33,66,37,40,43,14,26,12,23,16,56,117,176,239,367,530,652,762,886,935,878,766,668,560,407,259,144,76,28,47,68,53,74,88,62,93,122,90,66,51,52,194,452,907,1460,2042,2656,3208,3635,3854,3793,3449,2825,2093,1431,891,492,219,200,300,379,409,385,361,340,323,340,364,358,366,390,334,276,279,249,220,190,131,106,95,107,132,127,136,149,131,125,128,119,97,93,98,95,102,139,146,116,117,156,187,182,155,130,103,116,141,121,100,87,54,18,7,28,13,57,62,20,19,40,43,31,17,45,72,62]
#sample_data = [0,22,114,214,201,303,1472,4172,6690,7261,6413,5317,4377,3625,2981,2389,1926,1604,1412,2034,4077,6013,6168,5235,4310,3574,2976,2482,2048,1688,1408,1165,964,787,640,551,470,381,305,244,200,176,153,110,83,74,72,48,34,62,46,35,10,9,29,26,33,17,22,9,26,48,45,23,25,47,34,66,69,61,87,152,231,291,359,408,410,436,467,470,459,419,375,340,287,239,212,243,302,411,632,911,1162,1388,1620,1795,1861,1807,1577,1258,989,758,545,378,239,171,166,142,153,189,203,194,199,215,201,183,178,159,127,114,150,167,124,113,108,90,108,106,113,121,82,72,95,78,24,30,33,38,37,42,48,61,50,41,58,37,37,87,88,39,102,293,613,1014,1386,1718,2053,2326,2403,2211,1861,1516,1197,991,998,1196,1417,1578,1683,1613,1337,1007,700,529,627,790,865,875,893,846,685,528,441,333,190,92,40,53,140,198,186,132,107,101,153,210,255,329,398,422,374,348,352,298,273,231,199,225,248,314,389,405,397,374,310,237,225,250,302,364,402,385,326,236,166]
#sample_data = [0,22,105,205,184,136,670,1995,3150,3302,2851,2310,1798,1401,1156,978,810,703,696,1036,1891,2648,2645,2135,1696,1433,1191,961,798,663,564,526,469,376,325,275,219,193,159,125,111,74,57,78,67,34,34,56,54,47,54,36,21,11,39,12,24,23,39,41,17,13,33,30,17,69,181,354,601,872,1164,1476,1729,1849,1826,1694,1475,1199,940,728,585,531,488,418,368,296,207,175,158,116,77,41,44,52,42,48,32,32,34,15,34,48,15,29,42,41,17,1,1,1,0,10,40,62,47,23,16,23,9,22,51,165,459,849,1316,1836,2344,2841,3223,3404,3357,2990,2472,2028,1605,1214,942,754,612,507,382,240,157,103,39,37,38,26,23,10,14,31,70,61,72,103,98,93,90,31,42,103,106,128,152,123,81,56,46,16,37,53,54,42,39,28,46,59,64,70,73,97,102,75,80,96,102,136,164,127,121,128,136,132,147,153,146,140,114,121,133,115,127,140,120,86,86,92,60,44,22,21,72,53,20,10,50,25,63,42,31,48,46,43,66]
#sample_data  = [0,22,101,178,143,238,1382,3967,6440,7042,6224,5189,4283,3520,2948,2466,2013,1655,1453,2049,3973,5851,6139,5340,4451,3670,2992,2459,2060,1720,1416,1201,1000,792,661,567,480,409,360,376,387,370,411,495,541,581,644,649,577,495,427,406,418,349,203,127,214,526,1000,1635,2384,3174,3923,4537,5010,5256,5092,4599,4023,3518,3182,2992,2861,2778,2704,2583,2418,2197,1950,1717,1466,1224,1024,808,565,364,233,130,58,82,102,150,165,129,190,222,154,178,234,254,263,229,191,180,153,125,143,148,226,730,1681,2981,4515,6200,7875,9334,10369,10693,10108,8796,7304,6132,5398,4936,4561,4136,3628,3095,2590,2184,1981,1966,1943,1804,1634,1475,1295,1121,986,911,846,742,625,514,430,351,253,140,116,152,227,280,223,192,208,197,214,239,221,215,236,222,209,205,208,222,221,210,162,93,84,144,220,282,336,370,362,340,294,185,116,362,723,1120,1567,2042,2486,2827,2975,2871,2596,2264,1918,1619,1384,1147,937,790,703,650,621,606,587,568,533,504,502,503,514,557,601,627,653,646,589,502,391,288,202,90,36,77,129,205]
#sample_data  = [0,22,101,195,175,210,1392,4051,6518,7118,6312,5233,4305,3521,2879,2361,1920,1594,1431,2055,3988,5859,6140,5333,4448,3671,2974,2436,2042,1707,1412,1151,937,792,661,528,441,401,406,474,583,739,931,1117,1288,1406,1454,1469,1444,1384,1396,1484,1511,1440,1338,1216,998,646,158,529,1236,1931,2636,3243,3672,3903,3846,3473,2949,2506,2200,1929,1735,1681,1653,1625,1588,1468,1278,1066,861,653,482,411,437,461,507,553,538,499,438,363,297,258,263,265,241,223,233,239,237,224,197,150,114,110,88,49,125,289,576,844,1021,1125,1154,1170,1379,1773,2346,3098,3755,4071,3976,3562,2965,2352,1838,1454,1453,1969,2650,3094,3149,2907,2502,2075,1705,1394,1175,1019,854,713,635,623,704,802,874,989,1111,1173,1190,1159,1074,978,921,915,895,847,841,854,820,781,773,737,662,631,619,574,494,385,277,242,262,290,292,271,259,235,201,162,107,236,589,960,1384,1882,2345,2682,2848,2791,2556,2253,1946,1684,1481,1284,1096,963,863,782,751,733,685,643,640,598,519,461,385,315,263,198,156,142,176,258,278,235,226,215,198,213,195,163]
sample_data = [0,21,87,153,157,310,1650,4568,7216,7656,6557,5345,4383,3605,2971,2428,1986,1659,1450,1974,3776,5490,5612,4761,3902,3165,2558,2093,1719,1427,1179,933,744,625,510,397,314,265,235,194,141,126,123,85,55,70,96,119,207,365,488,576,685,741,723,691,654,580,556,588,633,691,692,690,678,545,334,570,1228,2027,2870,3693,4381,4814,4910,4671,4218,3698,3218,2814,2446,2079,1752,1531,1337,1128,960,810,727,753,845,1021,1300,1630,1920,2109,2189,2178,2054,1846,1651,1518,1439,1345,1266,1232,1161,1110,1080,998,887,765,678,613,505,398,341,319,289,239,190,158,173,213,214,186,145,121,122,151,219,273,342,427,505,544,510,436,361,305,257,198,229,437,949,1764,2828,4049,5307,6530,7566,8175,8259,7905,7236,6426,5659,4982,4472,4206,4119,4152,4299,4519,4714,4777,4659,4355,3935,3533,3213,2931,2673,2472,2282,2064,1876,1731,1589,1442,1297,1203,1162,1110,1014,897,760,569,366,188,98,218,289,305,257,144,93,106,98,91,38,16,53,70,42,5,36,99,140,149,182,215,198,145,147,167,162,210,315,370,380,374,364]
if __name__ == "__main__":
    result = compute_thresholds(sample_data)
    plot_data_with_thresholds5(sample_data, result)